import os
import sys

# key sizes
k1size = 32  # 0x20
k2size = 64  # 0x40

# offset to k2
k2_offset = 720  # 2D0

# offset to payload
pl_offset = 792  # 0x318

# offset to first instruction
junk_char_length_offset = 100  # 0x64
good_char_length_offset = 168  # 0xA8

# header bytes
header = 'MZ'


def key_schedule(_key):
    key = _key
    if not isinstance(_key, list):
        key = list(_key)
    keylength = len(key)
    S = range(256)
    j = 0
    for i in range(256):
        k = key[i % keylength]
        if not isinstance(key[i % keylength], int):
            k = ord(key[i % keylength])
        j = (j + S[i] + k) % 256
        S[i], S[j] = S[j], S[i]  # swap
    return S, j


def RC4_dcrpt(_key, _enc):
    result = []
    S, j = key_schedule(_key)
    enc = _enc
    if not isinstance(_enc, list):
        enc = list(_enc)
    m = len(enc)
    i = 0
    for c in enc:
        i = (i + 1) % 256
        j = (j + S[i]) % 256
        S[i], S[j] = S[j], S[i]
        k = S[(S[i] + S[j]) % 256]
        m -= 1
        if not isinstance(c, int):
            result.append(ord(c) ^ k)
        else:
            result.append(c ^ k)
    return result


def deflate_pl(junk, good_data, _data):
    data = list(_data)
    new_data = []
    j = 0
    k = 0
    new_data.append(ord(data[0]))
    i = 1
    while i < len(data):
        if j != junk:
            j = junk
            i += j
        if j == junk:
            if k < good_data:
                new_data.append(ord(data[i]))
                k += 1
                i += 1
            else:
                j = 0
                k = 0
    return new_data


with open(sys.argv[1], 'rb') as encrypted_file:

    # Get the file size
    file_size = os.path.getsize(sys.argv[1])

    # Get the first key of 0x20 bytes
    k1 = encrypted_file.read(k1size)

    # Get the start of deflate instructions
    encrypted_info = encrypted_file.read(pl_offset - k1size)

    # Get the bytes for the payload
    encrypted_pl = encrypted_file.read(file_size-pl_offset)

    # 1. dcrpt the deflation instructions
    dcrpted_info = RC4_dcrpt(k1, encrypted_info)

    # 2. Get instructions from the dcrpted data
    junk_char_length = dcrpted_info[junk_char_length_offset-k1size]
    good_char_length = dcrpted_info[good_char_length_offset-k1size]

    # 3. deflate payload
    deflated_pl = deflate_pl(junk_char_length, good_char_length, encrypted_pl)

    # 4. get k2
    k2 = []
    for i in range(k2size):
        k2.append(dcrpted_info[(k2_offset-k1size)+i])

    # 5. dcrpt enc3
    dcrpted_pl = RC4_dcrpt(k2, deflated_pl)

    # 6. fix header
    for i in range(len(header)):
        dcrpted_pl[i] = ord(header[i])

    # write to file
    with open("decrypted_payload.exe", 'wb') as out:
        for i in dcrpted_pl:
            out.write(chr(i))
        out.close()